;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Test readImageBlockMetadata
; Exercise the readImageBlockMetadata command.  We're going to do the following:
; - confirm that readImageBlockMetadata succeeds, and contains all required properties
;
; Arguments
; arg:1 - image block to read
; arg:2 - thumbnail flag (true/false)
; arg:3 - expected state
;
; Locals
; readimageblockmetadataresult - result of the test
;
; returns: pass or fail
;



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Display the banner...
;
echo
echo 'Test readImageBlockMetadata v1.0 17-Jul-2017'
set readimageblockmetadataresult 'pass'



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Call readImageBlockMetadata, and check the return properties...
;
call READIMAGEBLOCKMETADATA '${arg:1}' '${arg:2}' '${arg:3}'



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Bye-bye...
;
echopassfail 'SUMMARY' '${get:readimageblockmetadataresult}'
return '${get:readimageblockmetadataresult}'



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; READIMAGEBLOCKMETADATA
; arg:1 - image block to read
; arg:2 - thumbnail flag (true/false)
; arg:3 - expected state
; returns pass or fail
;
:READIMAGEBLOCKMETADATA
;
; Send the command...
readImageBlockMetadata '${arg:1}' '${arg:2}'
;
; Check the header...
call CHECKREPONSEHEADERS '${arg:2}'
;
; Check the mandatory properties...
run 'function CheckJsonProperty' 'TL.RIBM.003' 'readimageblockmetadataresult' 'kind' == 'twainlocalscanner'
run 'function CheckJsonProperty' 'TL.RIBM.004' 'readimageblockmetadataresult' 'commandId'
run 'function CheckJsonProperty' 'TL.RIBM.005' 'readimageblockmetadataresult' 'method' == 'readImageBlockMetadata'
run 'function CheckJsonProperty' 'TL.RIBM.006' 'readimageblockmetadataresult' 'results'
run 'function CheckJsonProperty' 'TL.RIBM.007' 'readimageblockmetadataresult' 'results.success' == 'true'
run 'function CheckJsonProperty' 'TL.RIBM.008' 'readimageblockmetadataresult' 'results.session'
run 'function CheckJsonProperty' 'TL.RIBM.009' 'readimageblockmetadataresult' 'results.session.sessionId' != ''
run 'function CheckJsonProperty' 'TL.RIBM.010' 'readimageblockmetadataresult' 'results.session.revision' != ''
run 'function CheckJsonProperty' 'TL.RIBM.011' 'readimageblockmetadataresult' 'results.session.state' == '${arg:3}'
run 'function CheckJsonProperty' 'TL.RIBM.012' 'readimageblockmetadataresult' 'results.metadata'
run 'function CheckJsonProperty' 'TL.RIBM.013' 'readimageblockmetadataresult' 'results.metadata.status'
run 'function CheckJsonProperty' 'TL.RIBM.014' 'readimageblockmetadataresult' 'results.metadata.status.success' == 'true'
run 'function CheckJsonProperty' 'TL.RIBM.015' 'readimageblockmetadataresult' 'results.metadata.address'
if '${arg:1}' > '1' goto READIMAGEBLOCKMETADATA.CHECKOTHERIMAGEBLOCKS
	run 'function CheckJsonProperty' 'TL.RIBM.016f' 'readimageblockmetadataresult' 'results.metadata.address.imageNumber' '==' '1'
	run 'function CheckJsonProperty' 'TL.RIBM.017f' 'readimageblockmetadataresult' 'results.metadata.address.imagePart' '==' '1'
	run 'function CheckJsonProperty' 'TL.RIBM.018f' 'readimageblockmetadataresult' 'results.metadata.address.sheetNumber' '==' '1'
	goto READIMAGEBLOCKMETADATA.SKIPOTHERIMAGEBLOCKS
:READIMAGEBLOCKMETADATA.CHECKOTHERIMAGEBLOCKS
	run 'function CheckJsonProperty' 'TL.RIBM.016' 'readimageblockmetadataresult' 'results.metadata.address.imageNumber' '!=' ''
	run 'function CheckJsonProperty' 'TL.RIBM.017' 'readimageblockmetadataresult' 'results.metadata.address.imagePart' '!=' ''
	run 'function CheckJsonProperty' 'TL.RIBM.018' 'readimageblockmetadataresult' 'results.metadata.address.sheetNumber' '!=' ''
:READIMAGEBLOCKMETADATA.SKIPOTHERIMAGEBLOCKS
run 'function CheckJsonProperty' 'TL.RIBM.019' 'readimageblockmetadataresult' 'results.metadata.address.moreParts' '==' 'false' 'true'
run 'function CheckJsonProperty' 'TL.RIBM.020' 'readimageblockmetadataresult' 'results.metadata.address.source' '==' 'flatbed' 'feederFront' 'feederRear'
run 'function CheckJsonProperty' 'TL.RIBM.021' 'readimageblockmetadataresult' 'results.metadata.address.streamName' '==' 'stream0'
run 'function CheckJsonProperty' 'TL.RIBM.022' 'readimageblockmetadataresult' 'results.metadata.address.sourceName' '==' 'source0'
run 'function CheckJsonProperty' 'TL.RIBM.023' 'readimageblockmetadataresult' 'results.metadata.address.pixelFormatName' '==' 'pixelFormat0'
run 'function CheckJsonProperty' 'TL.RIBM.024' 'readimageblockmetadataresult' 'results.metadata.image'
run 'function CheckJsonProperty' 'TL.RIBM.025' 'readimageblockmetadataresult' 'results.metadata.image.compression' == 'none' 'group4' 'jpeg'
run 'function CheckJsonProperty' 'TL.RIBM.026' 'readimageblockmetadataresult' 'results.metadata.image.pixelFormat' == 'bw1' 'gray8' 'rgb24'
run 'function CheckJsonProperty' 'TL.RIBM.027' 'readimageblockmetadataresult' 'results.metadata.image.pixelHeight' != ''
run 'function CheckJsonProperty' 'TL.RIBM.028' 'readimageblockmetadataresult' 'results.metadata.image.pixelOffsetX' != ''
run 'function CheckJsonProperty' 'TL.RIBM.029' 'readimageblockmetadataresult' 'results.metadata.image.pixelOffsetY' != ''
run 'function CheckJsonProperty' 'TL.RIBM.030' 'readimageblockmetadataresult' 'results.metadata.image.pixelWidth' != ''
run 'function CheckJsonProperty' 'TL.RIBM.031' 'readimageblockmetadataresult' 'results.metadata.image.resolution' != ''
run 'function CheckJsonProperty' 'TL.RIBM.032' 'readimageblockmetadataresult' 'results.metadata.image.size' != ''
return '${get:readimageblockmetadataresult}'



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; CHECKREPONSEHEADERS
; arg:1 - thumbnail flag (true/false)
; returns pass or fail
;
:CHECKREPONSEHEADERS
;
; Handle a normal header...
if '${arg:1}' == 'true' goto CHECKREPONSEHEADERS.MULTIPART
run 'function CheckHeader' 'TL.RIBM.001' 'readimageblockmetadataresult' 'Content-Type' ~contains 'application/json' 'charset=utf-8'
run 'function CheckHeader' 'TL.RIBM.002' 'readimageblockmetadataresult' 'Content-Length' == '${rdata:#}'
return '${get:readimageblockmetadataresult}'
;
; Handle a multipart header...
:CHECKREPONSEHEADERS.MULTIPART
run 'function CheckJsonHeader' 'TL.RIBM.001m' 'readimageblockmetadataresult' 'Content-Type' ~contains 'application/json' 'charset=utf-8'
run 'function CheckJsonHeader' 'TL.RIBM.002m' 'readimageblockmetadataresult' 'Content-Length' == '${rj:#}'
return '${get:readimageblockmetadataresult}'
